---
title: "Colour_life_history_latitude"
author: "Kevin Healy"
date: "2024-06-27"
output:
  pdf_document: default
  html_document: default
---

This script outlines the main analysis associated with the manuscript "Higher 
levels of sexual dichromatism are related to Passerine birds with high adult 
survival rates in temperate latitudes"

#Packages

First we will need to install the `MCMCglmm`, `caper` and `phytools` packages.
You will also need the `mulTree` which you will need to download directly from
github, see the following link on how to download it 
(https://github.com/TGuillerme/mulTree)

```{r packages}

library(MCMCglmm)
library(caper)
library(mulTree)
library(phytools)

```


Upload the data which contains both coloration, annual survival and clutch size
data (see main manuscript for details).

```{r setup,}

col_data <- read.csv("Duclaux_et_al_final_data.csv")

col_data$animal <- col_data$latin_name

col_data_temp <- data.frame(latin_name = col_data$latin_name,
                           animal = col_data$animal,
                           VolumeUVS = col_data$VolumeUVS,
                           VolumeVS = col_data$VolumeVS,
                           LociUVS = col_data$LociUVS,
                           LociVS = col_data$LociVS,
                           MidpointLat = abs(col_data$MidpointLat),
                           BodyMass = col_data$BodyMass,
                           survival = col_data$survival,
                           clutch = col_data$clutch,
                           lat =  col_data$lat,
                           long = col_data$long,
                           Sex = col_data$Sex,
                           Mating_System = col_data$Mating_System,
                           MatingSys = col_data$MatingSys)

col_data_fin <- na.omit(col_data_temp)

col_data_fin$log10BodyMass <- log10(col_data_fin$BodyMass)
col_data_fin$log10survival <- log10(col_data_fin$survival)
col_data_fin$log10clutch <- log10(col_data_fin$clutch)

```

Upload the phylogeny based on the Jetz et al tree (https://birdtree.org/). 
This Aves_latitude_phy.tre phylogeny has already been matched to the species in 
the Duclaux_et_al_final_data.csv dataset for 100 random tree's.

```{r phylo}

phylo_match <- read.tree("Aves_latitude_phy.tre")


```

We now set up the multree object. Multree will run each of the 100 phylogenies 
for 2 chains using MCMCglmm and test convergence. These are exported but can be
read back in. As the run time for the full set of 100 trees is several weeks we
advise simply uploading the previous model runs.

```{r multy}
multree_birds <- as.mulTree(data= col_data_fin,
                            tree= phylo_match,
                            taxa= "latin_name")

multree_birds$random.terms <- ~animal + sp.col


class(multree_birds)
names(multree_birds)

```

We set the interactions, thinning and burnin for each of the chains in the 
MCMCglmm and the prior.

```{r paramaters}

parameters <- c(2400000, 1000, 400000)


priors <-list(R = list(V = 1, nu=0.002), 
            G = list(G1=list(V = 1, nu=0.002, alpha.mu= 0, alpha.V= 10^3),
                     G2=list(V = 1, nu=0.002, alpha.mu= 0, alpha.V= 10^3)
                     ))

```

#Life history residual models
To account for body mass effects in the life histroy traits we first run two 
models of survival versus log body mass and clutch size versus body mass. In
both cases we will than use the residuals of these models to include these life
history traits in the main model.

First run the survival life history model 

```{r multree survival resids, eval=FALSE}
Survial_mass <- survival ~ log10(BodyMass)

mulTree(mulTree.data = multree_birds,
        formula = Survial_mass,
        priors = priors,
        parameters = parameters,
        output = "Surv_mass",
        ESS= 1000,
        family= "gaussian",
        chains= 2)

```

Read model back in

```{r read survival resids}

Surv_mass_multree <- read.mulTree("Surv_mass")

resids_surviv <- col_data_fin$survival - c(summary(Surv_mass_multree)[1,1] 
                + log10(col_data_fin$BodyMass)*summary(Surv_mass_multree)[2,1])

```

Now run the clutch size life history model 

```{r multree clutch resids, eval=FALSE}
clutch_mass <- clutch ~ log10(BodyMass)

mulTree(mulTree.data = multree_birds,
        formula = clutch_mass,
        priors = priors,
        parameters = parameters,
        output = "clutch_mass",
        ESS= 1000,
        family= "gaussian",
        chains= 2)
```

Read clutch models back in

```{r read clutch resids}

clutch_mass_multree <- read.mulTree("clutch_mass")

resids_clutch <- col_data_fin$clutch - c(summary(clutch_mass_multree)[1,1] 
                + log10(col_data_fin$BodyMass)*summary(clutch_mass_multree)[2,1])

```

Now combine residuals with the main data

```{r multree predicted_data, eval=FALSE}


col_data_fin_pred <- data.frame(col_data_fin,
                           resids_surviv,
                           resids_clutch)

multree_predict <- as.mulTree(data= col_data_fin_pred,
                            tree= phylo_match,
                            taxa= "latin_name")

multree_predict$random.terms <- ~animal + sp.col

```

#Main Models
Now run the main models using the survival residuals

```{r fast-slow survival, eval=FALSE}

main_surv <- LociVS ~ MidpointLat*Sex + log10(BodyMass)*Sex + resids_surviv*Sex + MatingSys*Sex

mulTree(mulTree.data = multree_predict,
        formula = main_surv,
        priors = priors,
        parameters = parameters,
        output = "main_surv",
        ESS= 1000,
        family= "gaussian",
        chains= 2)
```

Read main global model with survival residuals

```{r read fast-slow survival}

main_surv_multree <- read.mulTree("main_surv")
summary(main_surv_multree)
```


Now with clutch size residuals

```{r fast-slow clutch, eval=FALSE}

main_clutch <- LociVS ~ MidpointLat*Sex + log10(BodyMass)*Sex + resids_clutch*Sex + MatingSys*Sex

mulTree(mulTree.data = multree_predict,
        formula = main_clutch,
        priors = priors,
        parameters = parameters,
        output = "main_clutch",
        ESS= 1000,
        family= "gaussian",
        chains= 2)

```

Read in the global clutch model

```{r read fast-slow clutch}

main_clutch_multree <- read.mulTree("main_clutch")
summary(main_clutch_multree)
```


#Regional models

Split the data into temperate and tropical species and clip the phylogeny
for each of the subsetted data sets.

```{r phylo match tropical}

col_data_trop <-  col_data_fin_pred[col_data_fin_pred$MidpointLat < 23.5,]

col_data_te <-  col_data_fin_pred[col_data_fin_pred$MidpointLat > 23.5,]

match_trop <- data.frame(species_m = unique(col_data_trop$latin_name),
                   species_d = unique(col_data_trop$latin_name))
                   
match_te <- data.frame(species_m = unique(col_data_te$latin_name),
                   species_d = unique(col_data_te$latin_name))

                   
phylo_trop <- list()
phylo_te <- list()


for (i in 1:100){
  
  phylo_trop[[i]] <- comparative.data(phy = phylo[[i]],
                 data = match_trop, 
                 names.col = species_m,
                 vcv = TRUE)$phy
  
  phylo_te[[i]] <- comparative.data(phy = phylo[[i]],
                 data = match_te, 
                 names.col = species_m,
                 vcv = TRUE)$phy
  
}

class(phylo_trop) <- "multiPhylo"
class(phylo_te) <- "multiPhylo"

#Tropical Multree model
multree_trop <- as.mulTree(data= col_data_trop,
                            tree= phylo_trop,
                            taxa= "latin_name")

multree_trop$random.terms <- ~animal + sp.col


#Temperate Multree model
multree_te <- as.mulTree(data= col_data_te,
                            tree= phylo_te,
                            taxa= "latin_name")

multree_te$random.terms <- ~animal + sp.col

```


#Tropical models

First test if survival is correlated with latitude for tropical.

```{r lat survival trop test model, eval=FALSE}

lat_trop_surv_test <- MidpointLat ~ resids_surviv*Sex

mulTree(mulTree.data = multree_trop,
        formula = lat_trop_surv_test,
        priors = priors,
        parameters = parameters,
        output = "lat_trop_surv_test",
        ESS= 1000,
        family= "gaussian",
        chains= 2)
```

Read latitude survial correlation test model

```{r read lat trop test model}

lat_trop_surv_test_multree <- read.mulTree("lat_trop_surv_test")
summary(lat_trop_surv_test_multree)
```

Same for clutch size is correlated with latitude for tropical.

```{r lat trop test model}

lat_trop_clutch_test <- MidpointLat ~ resids_clutch*Sex

mulTree(mulTree.data = multree_trop,
        formula = lat_trop_clutch_test,
        priors = priors,
        parameters = parameters,
        output = "lat_trop_clutch_test",
        ESS= 1000,
        family= "gaussian",
        chains= 2)
```

Read latitude clutch correlation test model

```{r read lat trop clutch test model}

lat_trop_clutch_test_multree <- read.mulTree("lat_trop_clutch_test")
summary(lat_trop_clutch_test_multree)
```

Main tropical model including survival

```{r trop test survival }

lat_trop_surv <- LociVS ~log10(BodyMass)*Sex + resids_surviv*Sex + MatingSys*Sex

mulTree(mulTree.data = multree_trop,
        formula = lat_trop_surv,
        priors = priors,
        parameters = parameters,
        output = "lat_trop_surv",
        ESS= 1000,
        family= "gaussian",
        chains= 2)
```

Read main tropical model including survival

```{r Read trop test survival }

lat_trop_surv_multree <- read.mulTree("lat_trop_surv")
summary(lat_trop_surv_multree)
```


Main tropical model including clutch size

```{r trop test survival clutch }


lat_trop_clutch <- LociVS ~log10(BodyMass)*Sex + resids_clutch*Sex + MatingSys*Sex

mulTree(mulTree.data = multree_trop,
        formula = lat_trop_clutch,
        priors = priors,
        parameters = parameters,
        output = "lat_trop_clutch",
        ESS= 1000,
        family= "gaussian",
        chains= 2)
```

Main tropical model including clutch size

```{r Read trop test clutch }

lat_trop_clutch_multree <- read.mulTree("lat_trop_clutch")
summary(lat_trop_clutch_multree)
```


#Temperate models

First test if survival is correlated with latitude within temperate regions 

```{r lat te test model, eval=FALSE}

lat_te_surv_test <- MidpointLat ~ resids_surviv*Sex

mulTree(mulTree.data = multree_te,
        formula = lat_te_surv_test,
        priors = priors,
        parameters = parameters,
        output = "lat_te_surv_test",
        ESS= 1000,
        family= "gaussian",
        chains= 2)
```

Read lat_te_surv_test models in

```{r read lat te test model}

lat_te_surv_test_multree <- read.mulTree("lat_te_surv_test")
summary(lat_te_surv_test_multree)
```


Same for clutch size is correlated with latitude for temperate

```{r lat te clutch test model, eval=FALSE}

lat_te_clutch_test <- MidpointLat ~ resids_clutch*Sex

mulTree(mulTree.data = multree_te,
        formula = lat_te_clutch_test,
        priors = priors,
        parameters = parameters,
        output = "lat_te_clutch_test",
        ESS= 1000,
        family= "gaussian",
        chains= 2)
```

Read in lat_te_clutch_test models.

```{r read lat te clutch test model}

lat_te_clutch_test_multree <- read.mulTree("lat_te_clutch_test")
summary(lat_te_clutch_test_multree)
```


Run main temperate models, first with just survial included.

```{r temperate survival, eval=FALSE}

lat_te_surv <- LociVS ~log10(BodyMass)*Sex + resids_surviv*Sex + MatingSys*Sex

mulTree(mulTree.data = multree_te,
        formula = lat_trop_surv,
        priors = priors,
        parameters = parameters,
        output = "lat_te_surv",
        ESS= 1000,
        family= "gaussian",
        chains= 2)
```

read in main temperate models which include survival

```{r read temperate survival }

lat_te_surv_multree <- read.mulTree("lat_te_surv")
summary(lat_te_surv_multree)
```


Run main temperate models, now with just clutch size included.

```{r te clutch, eval=FALSE}

lat_te_clutch <- LociVS ~log10(BodyMass)*Sex + resids_clutch*Sex + MatingSys*Sex

mulTree(mulTree.data = multree_te,
        formula = lat_te_clutch,
        priors = priors,
        parameters = parameters,
        output = "lat_te_clutch",
        ESS= 1000,
        family= "gaussian",
        chains= 2)
```

Read main temperate models with clutch size included.

```{r read te clutch}

lat_te_clutch_multree <- read.mulTree("lat_te_clutch")
summary(lat_te_clutch_multree)
```





























